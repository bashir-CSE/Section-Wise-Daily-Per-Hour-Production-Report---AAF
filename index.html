<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		/>
		<style>
			body {
				background: #f8fafc;
				font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
					Roboto, sans-serif;
			}
			.form-container {
				background-color: white;
				border-radius: 16px;
				border: 1px solid #f1f5f9;
				overflow: hidden;
				box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				width: 60%;
				margin: 0 auto;
			}
			.form-header {
				background: linear-gradient(135deg, #0d9488 0%, #05339c 100%);
				color: white;
				padding: 2rem 2rem;
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
				position: relative;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
			}
			.form-header h1 {
				font-size: 1.875rem;
				font-weight: 700;
				margin-bottom: 0.25rem;
				letter-spacing: -0.025em;
			}
			.form-header p {
				font-size: 1.125rem;
				font-weight: 400;
				opacity: 0.9;
			}
			.btn-primary {
				background-color: #0d9488;
				border-color: #0d9488;
			}
			.btn-primary:hover {
				background-color: #0f766e;
				border-color: #0f766e;
			}
			.btn-secondary {
				background-color: #f1f5f9;
				color: #475569;
				font-weight: 600;
				border-radius: 8px;
				padding: 0.875rem 2.25rem;
				transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
				border: 1px solid #e2e8f0;
				letter-spacing: 0.025em;
			}
			.btn-secondary:hover {
				background-color: #e2e8f0;
				border-color: #cbd5e1;
				transform: translateY(-1px);
				box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
					0 2px 4px -2px rgba(0, 0, 0, 0.05);
			}
			.table-header th {
				background-color: #f8fafc;
				color: #475569;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				font-size: 0.75rem;
				padding: 1rem 1.5rem;
				border-bottom: 2px solid #e2e8f0;
			}
			#item-table-body tr:hover {
				background-color: #f1f5f9;
			}
			.action-btn {
				cursor: pointer;
				position: relative;
				background: transparent;
				border: none;
				font-size: 1.25rem;
			}
			.add-row-btn {
				color: #849e19;
			}
			.delete-row-btn {
				color: #e53e3e;
			}
			.footer {
				text-align: center;
				margin-top: 3rem;
				padding: 1.5rem;
				color: #64748b;
				font-size: 0.875rem;
				border-top: 1px solid #f1f5f9;
				background: rgba(241, 245, 249, 0.4);
			}

			@media (max-width: 768px) {
				.form-container {
					width: 100%;
					margin: 0;
					border-radius: 0;
					border: none;
				}
				.form-header {
					padding: 1.5rem 1rem;
				}
				.form-header h1 {
					font-size: 1.5rem;
				}
				.form-header p {
					font-size: 1rem;
				}
				#production-form {
					padding: 1rem;
				}
				.row > * {
					padding-left: 0.5rem;
					padding-right: 0.5rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="container mt-5">
			<div class="form-container shadow-lg">
				<div class="form-header">
					<div
						id="current-date"
						class="position-absolute top-0 end-0 p-3"
					></div>
					<h1>Ayesha Abed Foundation, Gorpara</h1>
					<p>Section Wise Daily Per Hour Production Report</p>
				</div>

				<form id="production-form" class="p-4">
					<div class="row g-3 mb-4 d-flex justify-content-between">
						<div class="col-md-3">
							<div class="form-floating">
								<select
									class="form-select"
									id="section-name"
									name="section-name"
									required
								>
									<option value="" disabled selected>Loading...</option>
								</select>
								<label for="section-name"
									><i class="fas fa-building me-2"></i>Section Name</label
								>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-floating">
								<select class="form-select" id="time" name="time" required>
									<option value="" disabled selected>Loading...</option>
								</select>
								<label for="time"
									><i class="fas fa-clock me-2"></i>Time Slot</label
								>
							</div>
						</div>
					</div>

					<div class="table-responsive rounded border shadow-sm mb-4">
						<table class="table table-striped mb-0">
							<thead class="table-header">
								<tr>
									<th scope="col" class="text-left">Item Name</th>
									<th scope="col" class="text-center">Quantity</th>
									<th scope="col" class="text-center">Action</th>
								</tr>
							</thead>
							<tbody id="item-table-body"></tbody>
						</table>
					</div>

					<div
						class="d-flex justify-content-center align-items-center gap-3 mt-4"
					>
						<button
							id="clear-button"
							type="button"
							class="btn btn-outline-danger"
							data-bs-toggle="tooltip"
							data-bs-placement="top"
							title="Clear all fields"
						>
							<i class="fas fa-undo me-2"></i>Clear Form
						</button>
						<button
							id="view-reports-button"
							type="button"
							class="btn btn-outline-info"
							data-bs-toggle="tooltip"
							data-bs-placement="top"
							title="View past submission reports"
						>
							<i class="fas fa-history me-2"></i>View Past Reports
						</button>
						<button
							id="submit-button"
							type="submit"
							class="btn btn-primary"
							data-bs-toggle="tooltip"
							data-bs-placement="top"
							title="Submit the report"
						>
							<i class="fas fa-paper-plane me-2"></i>Submit Report
						</button>
					</div>
				</form>
			</div>
			<div class="footer">
				<p>
					Designed and developed by Md Bashir Ahmed. MIS, Ayesha Abed
					Foundation, Manikganj, Gorpara.
				</p>
				<p>For any assistance, contact: 01332547334</p>
			</div>
		</div>

		<!-- Confirmation Modal -->
		<div
			class="modal fade"
			id="confirmation-modal"
			tabindex="-1"
			aria-labelledby="confirmationModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="confirmationModalLabel">
							Confirm Submission
						</h5>
					</div>
					<div class="modal-body">
						Are you sure you want to submit this report?
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-danger btn-sm"
							data-bs-dismiss="modal"
						>
							Cancel
						</button>
						<button
							type="button"
							id="modal-confirm"
							class="btn btn-success btn-sm"
						>
							Confirm
						</button>
					</div>
				</div>
			</div>
		</div>

		<template id="item-options-template">
			<option value="" disabled selected>Select an Item</option>
		</template>

		<!-- View Reports Modal -->
		<div
			class="modal fade"
			id="view-reports-modal"
			tabindex="-1"
			aria-labelledby="viewReportsModalLabel"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="viewReportsModalLabel">Past Reports</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<div class="modal-body">
						<div class="row g-3 mb-3">
							<div class="col-md-8">
								<input
									type="text"
									class="form-control"
									id="search-input"
									placeholder="Search reports..."
								/>
							</div>
							<div class="col-md-4">
								<input
									type="date"
									class="form-control"
									id="date-filter-input"
								/>
							</div>
						</div>
						<div class="table-responsive">
							<table
								class="table table-bordered table-success table-striped table-hover"
							>
								<thead class="table-dark">
									<tr>
										<th scope="col">Timestamp</th>
										<th scope="col">Section</th>
										<th scope="col">Time</th>
										<th scope="col">Item</th>
										<th scope="col">Quantity</th>
									</tr>
								</thead>
								<tbody id="reports-table-body">
									<tr>
										<td colspan="5" class="text-center">Loading reports...</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-secondary"
							data-bs-dismiss="modal"
						>
							Close
						</button>
					</div>
				</div>
			</div>
		</div>

		<div
			class="toast-container position-fixed top-0 end-0 p-3"
			style="z-index: 11"
		>
			<div
				id="liveToast"
				class="toast"
				role="alert"
				aria-live="assertive"
				aria-atomic="true"
			>
				<div class="toast-header">
					<strong class="me-auto">Notification</strong>
					<small>Just now</small>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="toast"
						aria-label="Close"
					></button>
				</div>
				<div class="toast-body" id="toast-message">
					Your report was submitted successfully!
				</div>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const tooltipTriggerList = document.querySelectorAll(
					'[data-bs-toggle="tooltip"]'
				);
				const tooltipList = [...tooltipTriggerList].map(
					(tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
				);

				const form = document.getElementById("production-form");
				const tableBody = document.getElementById("item-table-body");
				const itemOptionsTemplate = document.getElementById(
					"item-options-template"
				);
				const clearButton = document.getElementById("clear-button");
				const submitButton = document.getElementById("submit-button");
				const modal = new bootstrap.Modal(
					document.getElementById("confirmation-modal")
				);
				const modalConfirm = document.getElementById("modal-confirm");
				const viewReportsModal = new bootstrap.Modal(
					document.getElementById("view-reports-modal")
				);
				const viewReportsButton = document.getElementById(
					"view-reports-button"
				);
				const reportsTableBody = document.getElementById("reports-table-body");
				const searchInput = document.getElementById("search-input");
				let allReports = null;
				let filteredReports = null;

				viewReportsButton.addEventListener("click", () => {
					viewReportsModal.show();
					loadReports();
				});

				function loadReports() {
					reportsTableBody.innerHTML =
						'<tr><td colspan="5" class="text-center">Loading reports...</td></tr>';
					google.script.run
						.withSuccessHandler((reports) => {
							allReports = reports;
							filteredReports = reports;
							displayReports(reports);
						})
						.withFailureHandler((error) => {
							reportsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading reports: ${error.message}</td></tr>`;
						})
						.getPastReports();
				}

				function displayReports(reports) {
					if (reports.length === 0) {
						reportsTableBody.innerHTML =
							'<tr><td colspan="5" class="text-center">No reports found.</td></tr>';
						return;
					}

					reportsTableBody.innerHTML = "";
					reports.forEach((report) => {
						const row = document.createElement("tr");
						row.innerHTML = `
							<td>${report[0]}</td>
							<td>${report[1]}</td>
							<td>${report[2]}</td>
							<td>${report[3]}</td>
							<td>${report[4]}</td>
						`;
						reportsTableBody.appendChild(row);
					});
				}

				const dateFilterInput = document.getElementById("date-filter-input");

				function filterReports() {
					if (!allReports) return;

					const searchTerm = searchInput.value.toLowerCase();
					const filterDate = dateFilterInput.value;

					filteredReports = allReports.filter((report) => {
						const parts = report[0].split("/");
						const formattedReportDate = `${parts[2]}-${parts[1]}-${parts[0]}`;

						const dateMatch = !filterDate || formattedReportDate === filterDate;
						const searchMatch =
							!searchTerm ||
							report.some((cell) =>
								cell.toString().toLowerCase().includes(searchTerm)
							);
						return dateMatch && searchMatch;
					});

					displayReports(filteredReports);
				}

				searchInput.addEventListener("input", filterReports);
				dateFilterInput.addEventListener("change", filterReports);

				function loadDropdownData() {
					console.log("Fetching dropdown data...");
					google.script.run
						.withSuccessHandler((data) => {
							console.log("Received dropdown data:", data);
							dropdownData = data;
							populateDropdowns();
							// Create the first row only after dropdowns are populated
							createNewRow();
						})
						.withFailureHandler((error) => {
							console.error("Failed to load dropdown data:", error);
							showToast(
								`Failed to load dropdown data: ${error.message}`,
								"danger"
							);
						})
						.getDropdownDataForClient();
				}

				function populateDropdowns() {
					const sectionSelect = document.getElementById("section-name");
					const timeSelect = document.getElementById("time");
					const itemTemplate = document.getElementById("item-options-template");

					// Populate Section dropdown
					sectionSelect.innerHTML =
						'<option value="" disabled selected>Select a Section</option>';
					dropdownData.sections.forEach((section) => {
						const option = document.createElement("option");
						option.value = section;
						option.textContent = section;
						sectionSelect.appendChild(option);
					});

					// Populate Time dropdown
					timeSelect.innerHTML =
						'<option value="" disabled selected>Select a Time</option>';
					dropdownData.times.forEach((time) => {
						const option = document.createElement("option");
						option.value = time;
						option.textContent = time;
						timeSelect.appendChild(option);
					});

					// Populate Item template
					itemTemplate.innerHTML =
						'<option value="" disabled selected>Select an Item</option>';
					dropdownData.items.forEach((item) => {
						const option = document.createElement("option");
						option.value = item;
						option.textContent = item;
						itemTemplate.appendChild(option);
					});
				}

				function createNewRow() {
					const newRow = document.createElement("tr");
					newRow.innerHTML = `
            <td class="align-middle">
              <div class="form-floating">
                <select name="item-name" class="item-name-select form-select" required>
                  <option value="" disabled selected>Select an Item</option>
                </select>
                <label for="item-name">Item Name</label>
              </div>
            </td>
            <td class="align-middle">
              <div class="form-floating">
                <input type="number" name="qty" class="qty-input form-control" placeholder="e.g., 50" min="0" required>
                <label for="qty">Quantity</label>
              </div>
            </td>
            <td class="text-center align-middle">
              <button type="button" class="add-row-btn action-btn" data-bs-toggle="tooltip" data-bs-placement="top" title="Add new row">
                <i class="fas fa-plus-circle"></i>
              </button>
              <button type="button" class="delete-row-btn action-btn ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete this row">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          `;

					const newSelect = newRow.querySelector(".item-name-select");
					if (dropdownData && dropdownData.items) {
						dropdownData.items.forEach((item) => {
							const option = document.createElement("option");
							option.value = item;
							option.textContent = item;
							newSelect.appendChild(option);
						});
					}

					tableBody.appendChild(newRow);
					const newTooltips = newRow.querySelectorAll(
						'[data-bs-toggle="tooltip"]'
					);
					[...newTooltips].map(
						(tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
					);
					updateDeleteButtons();
				}

				function updateDeleteButtons() {
					const rows = tableBody.querySelectorAll("tr");
					rows.forEach((row, index) => {
						const deleteBtn = row.querySelector(".delete-row-btn");
						if (deleteBtn) {
							deleteBtn.style.display =
								rows.length > 1 ? "inline-block" : "none";
						}
					});
				}

				tableBody.addEventListener("click", (e) => {
					const addBtn = e.target.closest(".add-row-btn");
					const deleteBtn = e.target.closest(".delete-row-btn");
					if (addBtn) {
						createNewRow();
					}
					if (deleteBtn) {
						deleteBtn.closest("tr").remove();
						updateDeleteButtons();
					}
				});

				clearButton.addEventListener("click", () => {
					form.reset();
					tableBody.innerHTML = "";
					createNewRow();
					const toast = new bootstrap.Toast(toastLiveExample);
					toastMessage.textContent = "Form has been cleared.";
					toast.show();
				});

				function showToast(message, type = "success") {
					const toastLiveExample = document.getElementById("liveToast");
					const toastMessage = document.getElementById("toast-message");

					toastMessage.textContent = message;
					toastLiveExample.className = `toast bg-${type}`;

					const toast = new bootstrap.Toast(toastLiveExample, {
						delay: 5000,
						autohide: true,
					});

					toast.show();
				}

				function handleSubmission() {
					submitButton.disabled = true;
					submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...`;

					const resetSubmitButton = () => {
						submitButton.disabled = false;
						submitButton.innerHTML = `<i class="fas fa-paper-plane me-2"></i>Submit Report`;
					};

					google.script.run
						.withSuccessHandler((response) => {
							if (response.status === "success") {
								showToast(response.message, "success");
								setTimeout(() => {
									form.reset();
									tableBody.innerHTML = "";
									createNewRow();
								}, 500);
							} else {
								showToast(`Error: ${response.message}`, "danger");
							}
							resetSubmitButton();
						})
						.withFailureHandler((error) => {
							showToast(`Submission failed: ${error.message}`, "danger");
							resetSubmitButton();
						})
						.saveData(formDataToSubmit);
				}

				form.addEventListener("submit", (e) => {
					e.preventDefault();
					if (!form.checkValidity()) {
						form.reportValidity();
						return;
					}
					const sectionName = document.getElementById("section-name").value;
					const time = document.getElementById("time").value;
					const items = [];
					tableBody.querySelectorAll("tr").forEach((row) => {
						const itemName = row.querySelector(".item-name-select").value;
						const qty = row.querySelector(".qty-input").value;
						if (itemName && qty) {
							items.push({ itemName, qty: parseInt(qty, 10) });
						}
					});
					if (items.length === 0) {
						alert("Please add at least one item row with a quantity.");
						return;
					}
					formDataToSubmit = { sectionName, time, items };
					modal.show();
				});

				modalConfirm.addEventListener("click", () => {
					modal.hide();
					handleSubmission();
				});

				function displayDate() {
					const dateElement = document.getElementById("current-date");
					const today = new Date();
					const options = {
						weekday: "long",
						year: "numeric",
						month: "long",
						day: "numeric",
					};
					dateElement.textContent = today.toLocaleDateString("en-US", options);
				}

				displayDate();
				loadDropdownData();
			});
		</script>
	</body>
</html>
